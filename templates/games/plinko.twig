{% extends 'layout.twig' %}

{% block title %}ðŸŽ¯ Plinko{% endblock %}

{% block content %}
<div class="container">
    <div class="game-container">
        <div class="game-header">
            <h1>ðŸŽ¯ Plinko</h1>
            <p>Wirf die Kugel und hoffe auf hohe Multiplikatoren!</p>
        </div>

        <div class="plinko-game">
            <div class="plinko-controls">
                <div class="control-group">
                    <label>Einsatz</label>
                    <input type="number" id="betAmount" class="game-input" value="100" min="10" max="{{ user.fietzPoints }}">
                </div>
                
                <div class="control-group">
                    <label>Risiko</label>
                    <select id="riskLevel" class="game-input">
                        <option value="low">Niedrig</option>
                        <option value="medium" selected>Mittel</option>
                        <option value="high">Hoch</option>
                    </select>
                </div>
                
                <button id="playBtn" class="btn btn-primary btn-lg">Spielen</button>
            </div>

            <div class="plinko-board" id="plinkoBoard">
                <canvas id="plinkoCanvas" width="600" height="700"></canvas>
            </div>

            <div class="plinko-multipliers" id="multipliers">
                <!-- Will be populated by JavaScript -->
            </div>

            <div class="result-display" id="result" style="display: none;">
                <div class="result-multiplier"></div>
                <div class="result-win"></div>
            </div>
        </div>
    </div>
</div>

<style>
.plinko-game {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 2rem;
}

.plinko-controls {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    align-items: flex-end;
}

.control-group {
    flex: 1;
}

.control-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--text-secondary);
}

.plinko-board {
    background: var(--bg-primary);
    border-radius: 12px;
    padding: 2rem;
    display: flex;
    justify-content: center;
    margin-bottom: 1rem;
}

#plinkoCanvas {
    max-width: 100%;
    border: 1px solid var(--border-color);
    border-radius: 8px;
}

.plinko-multipliers {
    display: flex;
    justify-content: space-around;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.multiplier-slot {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 0.5rem;
    min-width: 50px;
    text-align: center;
    font-weight: 700;
}

.multiplier-slot.high {
    background: var(--success);
    color: white;
}

.multiplier-slot.medium {
    background: var(--warning);
    color: white;
}

.multiplier-slot.low {
    background: var(--danger);
    color: white;
}

.result-display {
    text-align: center;
    margin-top: 2rem;
    padding: 2rem;
    background: var(--bg-tertiary);
    border-radius: 12px;
}

.result-multiplier {
    font-size: 3rem;
    font-weight: 700;
    color: var(--accent-primary);
    margin-bottom: 1rem;
}

.result-win {
    font-size: 1.5rem;
    color: var(--text-secondary);
}
</style>

<script>
const multipliers = {
    low: [0.5, 0.8, 1.0, 1.3, 1.5, 1.8, 2.0, 2.2, 2.5, 2.2, 2.0, 1.8, 1.5, 1.3, 1.0, 0.8, 0.5],
    medium: [0.3, 0.7, 1.0, 1.5, 2.0, 3.0, 4.0, 5.0, 10.0, 5.0, 4.0, 3.0, 2.0, 1.5, 1.0, 0.7, 0.3],
    high: [0.2, 0.5, 0.8, 1.2, 2.0, 5.0, 10.0, 20.0, 50.0, 20.0, 10.0, 5.0, 2.0, 1.2, 0.8, 0.5, 0.2]
};

function updateMultiplierDisplay() {
    const risk = document.getElementById('riskLevel').value;
    const container = document.getElementById('multipliers');
    container.innerHTML = '';
    
    multipliers[risk].forEach(mult => {
        const slot = document.createElement('div');
        slot.className = 'multiplier-slot';
        if (mult >= 5) slot.classList.add('high');
        else if (mult >= 2) slot.classList.add('medium');
        else slot.classList.add('low');
        slot.textContent = mult + 'x';
        container.appendChild(slot);
    });
}

updateMultiplierDisplay();
document.getElementById('riskLevel').addEventListener('change', updateMultiplierDisplay);

document.getElementById('playBtn').addEventListener('click', async () => {
    const betAmount = parseInt(document.getElementById('betAmount').value);
    const risk = document.getElementById('riskLevel').value;
    
    document.getElementById('playBtn').disabled = true;
    document.getElementById('result').style.display = 'none';
    
    try {
        const response = await fetch('/games/plinko/play', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount: betAmount, risk }),
        });
        
        const result = await response.json();
        
        if (result.id) {
            // Animate ball drop (simplified)
            setTimeout(() => {
                const resultDiv = document.getElementById('result');
                resultDiv.style.display = 'block';
                resultDiv.querySelector('.result-multiplier').textContent = result.multiplier + 'x';
                resultDiv.querySelector('.result-win').textContent = 
                    result.winAmount > betAmount 
                        ? `Gewonnen: ${result.winAmount} FIETZ Points!` 
                        : `Verloren: ${betAmount - result.winAmount} FIETZ Points`;
                
                if (result.winAmount > betAmount) {
                    window.BetScript.showNotification(`Gewonnen: ${result.winAmount} FP!`, 'success');
                }
                
                document.getElementById('playBtn').disabled = false;
                
                setTimeout(() => window.location.reload(), 3000);
            }, 2000);
        } else {
            window.BetScript.showNotification('Fehler beim Spielen', 'error');
            document.getElementById('playBtn').disabled = false;
        }
    } catch (error) {
        window.BetScript.showNotification('Fehler beim Spielen', 'error');
        document.getElementById('playBtn').disabled = false;
    }
});

// TODO: Implement actual Plinko board animation with Canvas
</script>
{% endblock %}
