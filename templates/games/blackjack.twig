{% extends 'layout.twig' %}

{% block title %}üÉè Blackjack{% endblock %}

{% block content %}
<div class="container">
    <div class="game-container">
        <div class="game-header">
            <h1>üÉè Blackjack</h1>
            <p>Schlage den Dealer ohne √ºber 21 zu gehen!</p>
        </div>

        <div class="blackjack-game">
            <div id="startScreen" class="game-screen">
                <div class="bet-input-group">
                    <label>Einsatz</label>
                    <input type="number" id="betAmount" class="game-input" value="100" min="10" max="{{ user.fietzPoints }}">
                </div>
                <button id="startBtn" class="btn btn-primary btn-lg">Spiel starten</button>
            </div>

            <div id="gameScreen" class="game-screen" style="display: none;">
                <div class="dealer-area">
                    <h3>Dealer <span id="dealerScore"></span></h3>
                    <div class="card-hand" id="dealerHand"></div>
                </div>

                <div class="player-area">
                    <h3>Du <span id="playerScore"></span></h3>
                    <div class="card-hand" id="playerHand"></div>
                </div>

                <div class="game-actions">
                    <button id="hitBtn" class="btn btn-primary">Hit</button>
                    <button id="standBtn" class="btn btn-secondary">Stand</button>
                </div>
            </div>

            <div id="resultScreen" class="game-screen" style="display: none;">
                <div class="result-message" id="resultMessage"></div>
                <div class="result-amount" id="resultAmount"></div>
                <button id="newGameBtn" class="btn btn-primary btn-lg">Neues Spiel</button>
            </div>
        </div>
    </div>
</div>

<style>
.blackjack-game {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 2rem;
    min-height: 500px;
}

.game-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2rem;
}

.dealer-area,
.player-area {
    width: 100%;
    text-align: center;
    margin: 1rem 0;
}

.dealer-area h3,
.player-area h3 {
    margin-bottom: 1rem;
}

.card-hand {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
    min-height: 120px;
}

.card {
    width: 80px;
    height: 120px;
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 700;
    color: #000;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.card.red {
    color: #e74c3c;
}

.card .suit {
    font-size: 2rem;
}

.game-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
}

.result-message {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
}

.result-message.win {
    color: var(--success);
}

.result-message.lose {
    color: var(--danger);
}

.result-message.push {
    color: var(--warning);
}

.result-amount {
    font-size: 1.5rem;
    color: var(--text-secondary);
    margin-bottom: 2rem;
}
</style>

<script>
let gameId = null;

document.getElementById('startBtn').addEventListener('click', async () => {
    const betAmount = parseInt(document.getElementById('betAmount').value);
    
    if (!betAmount || betAmount < 10) {
        if (window.BetScript && window.BetScript.showNotification) {
            window.BetScript.showNotification('Mindestens 10 FIETZ Points!', 'error');
        }
        return;
    }
    
    try {
        const response = await fetch('/games/blackjack/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount: betAmount }),
        });
        
        if (!response.ok) {
            throw new Error('Server error');
        }
        
        const result = await response.json();
        
        if (result && result.gameId && result.playerHand) {
            gameId = result.gameId;
            showGameScreen(result);
        } else {
            if (window.BetScript && window.BetScript.showNotification) {
                window.BetScript.showNotification(result.error || 'Nicht genug FIETZ Points!', 'error');
            } else {
                alert('Nicht genug FIETZ Points!');
            }
        }
    } catch (error) {
        console.error('Blackjack start error:', error);
        if (window.BetScript && window.BetScript.showNotification) {
            window.BetScript.showNotification('Fehler beim Starten', 'error');
        } else {
            alert('Fehler beim Starten');
        }
    }
});

document.getElementById('hitBtn').addEventListener('click', async () => {
    document.getElementById('hitBtn').disabled = true;
    document.getElementById('standBtn').disabled = true;
    
    const response = await fetch('/games/blackjack/hit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ gameId }),
    });
    
    const result = await response.json();
    
    if (result.status === 'bust') {
        showResult('lose', result);
    } else {
        updateHand('player', result.playerHand, result.playerScore);
        // Re-enable buttons
        document.getElementById('hitBtn').disabled = false;
        document.getElementById('standBtn').disabled = false;
    }
});

document.getElementById('standBtn').addEventListener('click', async () => {
    document.getElementById('hitBtn').disabled = true;
    document.getElementById('standBtn').disabled = true;
    
    const response = await fetch('/games/blackjack/stand', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ gameId }),
    });
    
    const result = await response.json();
    
    updateHand('dealer', result.dealerHand, result.dealerScore);
    updateHand('player', result.playerHand, result.playerScore);
    
    showResult(result.status, result);
});

document.getElementById('newGameBtn').addEventListener('click', () => {
    document.getElementById('startScreen').style.display = 'flex';
    document.getElementById('gameScreen').style.display = 'none';
    document.getElementById('resultScreen').style.display = 'none';
    document.getElementById('hitBtn').disabled = false;
    document.getElementById('standBtn').disabled = false;
    gameId = null;
});

function showGameScreen(data) {
    document.getElementById('startScreen').style.display = 'none';
    document.getElementById('gameScreen').style.display = 'flex';
    
    updateHand('dealer', data.dealerHand, '?');
    updateHand('player', data.playerHand, data.playerScore);
}

function updateHand(player, cards, score) {
    const handEl = document.getElementById(player + 'Hand');
    const scoreEl = document.getElementById(player + 'Score');
    
    handEl.innerHTML = '';
    cards.forEach(card => {
        const cardEl = document.createElement('div');
        cardEl.className = 'card';
        if (card.suit === '‚ô•' || card.suit === '‚ô¶') {
            cardEl.classList.add('red');
        }
        cardEl.innerHTML = `<div>${card.value}</div><div class="suit">${card.suit}</div>`;
        handEl.appendChild(cardEl);
    });
    
    scoreEl.textContent = `(${score})`;
}

function showResult(status, data) {
    document.getElementById('gameScreen').style.display = 'none';
    document.getElementById('resultScreen').style.display = 'flex';
    
    const messageEl = document.getElementById('resultMessage');
    const amountEl = document.getElementById('resultAmount');
    
    if (status === 'won') {
        messageEl.textContent = 'Gewonnen! üéâ';
        messageEl.className = 'result-message win';
        amountEl.textContent = `+${data.winAmount} FIETZ Points`;
        window.BetScript.showNotification(`Gewonnen: ${data.winAmount} FP!`, 'success');
    } else if (status === 'lost' || status === 'bust') {
        messageEl.textContent = 'Verloren üò¢';
        messageEl.className = 'result-message lose';
        amountEl.textContent = 'Einsatz verloren';
    } else if (status === 'push') {
        messageEl.textContent = 'Unentschieden';
        messageEl.className = 'result-message push';
        amountEl.textContent = 'Einsatz zur√ºckerstattet';
    }
    
    // Update points display without reload
    if (window.BetScript && window.BetScript.updatePoints) {
        window.BetScript.updatePoints();
    }
}
</script>
{% endblock %}
